# 2025年09月08日 - Jest設定とテスト環境構築

## 実施内容

### 問題発生
ユーザーからJestで「testやexpectがundefined」というエラーが報告された。

### 原因分析
1. ES6モジュールの`import`文をJestが認識できない
2. Babel設定が不足でES6→CommonJS変換されない
3. ESLint設定でJest環境のグローバル変数が未定義

### 解決手順

#### 1. Jest設定ファイル作成
```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  transform: {
    '^.+\\.js$': 'babel-jest',
  },
  moduleFileExtensions: ['js'],
  testMatch: ['**/test/**/*.test.js'],
  collectCoverageFrom: [
    'js/**/*.js',
    '!js/main.js'
  ]
};
```

#### 2. Babel設定ファイル作成
```javascript
// babel.config.js
module.exports = {
  presets: [
    ['@babel/preset-env', {
      targets: {
        node: 'current'
      }
    }]
  ]
};
```

#### 3. ESLint設定ファイル作成
```javascript
// .eslintrc.js
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true,
    jest: true  // これが重要
  },
  extends: ['eslint:recommended'],
  parserOptions: {
    ecmaVersion: 12,
    sourceType: 'module'
  }
};
```

### 結果
- テストが正常実行される（11パス、1失敗）
- `test`、`expect`、`describe`のundefinedエラーが解消
- ESLintエラーも解消

## 技術的学習ポイント

### Jest + ES6モジュールの組み合わせ
- デフォルトではJestはCommonJSを期待する
- ES6モジュールを使うにはBabel変換が必要
- `jest.config.js`で`babel-jest`を指定する

### 設定ファイルの優先順位
1. `jest.config.js` > `package.json`の`jest`フィールド
2. `babel.config.js` > `.babelrc`
3. `.eslintrc.js` > `.eslintrc.json`

## プロンプト改善提案

今回のやり取りでより効果的だったプロンプト例：

### 実際のプロンプト
「jestをインストールしましたが、testやexpectがundefinedになります。簡単なテストの例をひとつだけ作成してください。エラーの原因を示してください」

### より効果的だったであろうプロンプト
「Jest環境でES6モジュール（import文）を使ったテストファイルを作成したいです。現在`test`と`expect`がundefinedエラーになります。必要な設定ファイル（jest.config.js、babel.config.js等）を含めて、動作するテスト環境を構築してください」

**改善点**：
- ES6モジュール使用の明記
- 期待する設定ファイル名の具体的指定
- 「動作する環境構築」という明確なゴール設定

## 今後の改善点

1. **テストカバレッジ向上**: 現在1つのテストが失敗中
2. **テストヘルパー作成**: 共通のテスト用ユーティリティ
3. **CI/CD設定**: GitHub Actionsでの自動テスト実行
4. **モック設定**: Canvas APIなどブラウザAPIのモック化